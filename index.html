<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vocabulary Learning System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2d4059;
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header .current-date {
        color: #666;
        font-size: 1.1em;
      }

      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        height: 400px;
      }

      .statistics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #3498db;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
      }

      .input-section {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .search-bar {
        margin-bottom: 15px;
      }

      .search-bar input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
      }

      .input-group {
        display: grid;
        grid-template-columns: 1fr 1fr auto auto auto;
        gap: 10px;
        align-items: center;
      }

      input {
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s;
      }

      input:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      button:hover {
        background: #2980b9;
        transform: translateY(-2px);
      }

      .export-btn {
        background: #27ae60;
      }

      .import-btn {
        background: #8e44ad;
      }

      .boxes-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .box {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .box:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .box-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .box-header h3 {
        color: #2d4059;
        font-size: 1.5em;
        margin-bottom: 5px;
      }

      .word-count {
        background: #3498db;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 1.2em;
        font-weight: bold;
      }

      .word-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .word-item {
        background: #f8f9fa;
        padding: 12px;
        margin: 8px 0;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
      }

      .word-item:hover {
        transform: translateX(5px);
        background: #f0f0f0;
      }

      .word-content {
        flex: 1;
      }

      .word-text {
        font-weight: 500;
      }

      .word-translation {
        font-size: 0.9em;
        color: #666;
        margin-top: 4px;
      }

      .word-actions {
        display: flex;
        gap: 8px;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        padding: 0;
      }

      .audio-btn {
        background: #3498db;
        color: white;
      }

      .delete-btn {
        background: #e74c3c;
        color: white;
      }

      .flashcard-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .flashcard-container {
        width: 500px;
        perspective: 1000px;
      }

      .flashcard {
        position: relative;
        width: 100%;
        height: 300px;
        transform-style: preserve-3d;
        transition: transform 0.6s;
        cursor: pointer;
      }

      .flashcard.flipped {
        transform: rotateY(180deg);
      }

      .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .card-back {
        transform: rotateY(180deg);
      }

      .card-content {
        text-align: center;
      }

      .card-word {
        font-size: 24px;
        margin-bottom: 15px;
      }

      .card-controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 1001;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Settings button - Nút cài đặt */
      .settings-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #3498db;
        color: white;
        border: none;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 10000;
      }

      /* Settings modal - Modal cài đặt */
      .settings-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        align-items: center;
        justify-content: center;
      }

      /* Settings content - Nội dung cài đặt */
      .settings-content {
        background: white;
        width: 90%;
        max-width: 400px;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      }

      /* Settings header - Tiêu đề cài đặt */
      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .settings-header h2 {
        margin: 0;
        font-size: 20px;
      }

      .settings-close {
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
      }

      /* Settings options - Các tùy chọn cài đặt */
      .settings-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
      }

      /* Switch toggle - Nút chuyển đổi */
      .switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #3498db;
      }

      input:checked + .slider:before {
        transform: translateX(22px);
      }

      /* Reset button - Nút reset */
      .settings-option button {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Media queries for mobile */
      @media screen and (max-width: 768px) {
        .settings-content {
          margin: 15px;
          padding: 15px;
        }

        .settings-header h2 {
          font-size: 18px;
        }

        .settings-option {
          padding: 12px 0;
        }

        .settings-option span {
          font-size: 15px;
        }

        .settings-btn {
          bottom: 15px;
          right: 15px;
        }
      }

      /* Ensure visibility on rotate notice */
      .portrait-mode .settings-btn,
      .landscape-mode .settings-btn,
      .portrait-mode .settings-modal.active,
      .landscape-mode .settings-modal.active {
        display: flex !important;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #3498db;
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      /* Dark mode styles */
      /* Thay đổi phần dark mode styles trong CSS */
      body.dark-mode {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      }

      .dark-mode .box,
      .dark-mode .input-section,
      .dark-mode .stat-card,
      .dark-mode .chart-container,
      .dark-mode .settings-content,
      .dark-mode .card-face {
        background: #1a1a2e;
        color: #e1e1e1;
        border: 1px solid #30475e;
      }

      .dark-mode .word-item {
        background: #16213e;
        color: #e1e1e1;
        border: 1px solid #30475e;
      }

      .dark-mode input {
        background: #16213e;
        color: #e1e1e1;
        border: 2px solid #30475e;
      }

      .dark-mode input:focus {
        border-color: #4ecca3;
        box-shadow: 0 0 5px rgba(78, 204, 163, 0.3);
      }

      .dark-mode .header h1 {
        color: #e1e1e1;
      }

      .dark-mode .word-translation {
        color: #a5a5a5;
      }

      .dark-mode .box-header h3 {
        color: #4ecca3;
      }

      .dark-mode .stat-value {
        color: #4ecca3;
      }

      .dark-mode .stat-label {
        color: #a5a5a5;
      }

      .dark-mode .current-date {
        color: #a5a5a5;
      }
      .word-inputs {
        display: flex;
        gap: 10px;
        flex: 2;
      }

      .image-upload {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        flex: 1;
      }

      .image-preview {
        width: 100px;
        height: 100px;
        border: 2px dashed #e0e0e0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }

      .image-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
      }

      .image-preview .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(231, 76, 60, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .image-btn {
        background: #9b59b6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .image-btn:hover {
        background: #8e44ad;
      }

      /* Sửa lại style cho flashcard để hiển thị ảnh */
      .card-image {
        width: 200px;
        height: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 15px;
      }

      .card-image img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
      }

      .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .card-face.front {
        transform: rotateY(0deg);
      }

      .card-face.back {
        transform: rotateY(180deg);
      }

      .flashcard {
        position: relative;
        width: 100%;
        height: 400px; /* Tăng chiều cao để chứa ảnh */
        transform-style: preserve-3d;
        transition: transform 0.6s;
        cursor: pointer;
      }

      .flashcard.flipped {
        transform: rotateY(180deg);
      }

      .card-content {
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .card-word {
        font-size: 28px;
        margin: 10px 0;
      }

      .card-meaning {
        font-size: 24px;
      }
      /* Thông báo xoay màn hình */
      .rotate-notice {
        display: none; /* Mặc định ẩn */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }

      .rotate-content {
        text-align: center;
        color: white;
        padding: 20px;
        animation: bounce 2s infinite;
      }

      .rotate-content i {
        font-size: 50px;
        margin-bottom: 15px;
        display: block;
        transform: rotate(90deg);
      }

      .rotate-content p {
        font-size: 18px;
        margin: 0;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      /* Media queries cho điện thoại */
      @media screen and (max-width: 768px) and (orientation: portrait) {
        .container {
          display: none; /* Ẩn nội dung chính */
        }

        .rotate-notice {
          display: flex; /* Hiện thông báo */
        }
      }

      @media screen and (max-width: 768px) and (orientation: landscape) {
        .container {
          display: block; /* Hiện nội dung chính */
        }

        .rotate-notice {
          display: none; /* Ẩn thông báo */
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Vocabulary Learning System</h1>
        <div class="current-date" id="currentDate"></div>
      </div>

      <div class="statistics">
        <div class="stat-card">
          <div class="stat-value" id="totalWords">0</div>
          <div class="stat-label">Total Words</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="masteredWords">0</div>
          <div class="stat-label">Mastered Words</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="learningStreak">0</div>
          <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="reviewAccuracy">0%</div>
          <div class="stat-label">Review Accuracy</div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="retentionChart"></canvas>
      </div>

      <div class="input-section">
        <div class="search-bar">
          <input
            type="text"
            id="searchWords"
            placeholder="Search words..."
            oninput="vocabularyManager.filterWords(this.value)"
          />
        </div>
        <div class="input-group">
          <div class="word-inputs">
            <input
              type="text"
              id="englishWord"
              placeholder="Enter English word"
            />
            <input
              type="text"
              id="vietnameseMeaning"
              placeholder="Enter Vietnamese meaning"
            />
          </div>
          <div class="image-upload">
            <input
              type="file"
              id="wordImage"
              accept="image/*"
              style="display: none"
              onchange="vocabularyManager.handleImageUpload(event)"
            />
            <button
              class="image-btn"
              onclick="document.getElementById('wordImage').click()"
            >
              <i class="fas fa-image"></i> Add Image
            </button>
            <div id="imagePreview" class="image-preview"></div>
          </div>
          <div class="action-buttons">
            <button onclick="vocabularyManager.addWord()">
              <i class="fas fa-plus"></i> Add Word
            </button>
          </div>
        </div>
      </div>

      <div class="boxes-container">
        <div class="box" onclick="vocabularyManager.showFlashcards(100)">
          <div class="box-header">
            <h3>Mastered</h3>
            <span class="word-count">0</span>
          </div>
        </div>
        <div class="box" onclick="vocabularyManager.showFlashcards(75)">
          <div class="box-header">
            <h3>Learning</h3>
            <span class="word-count">0</span>
          </div>
        </div>
        <div class="box" onclick="vocabularyManager.showFlashcards(50)">
          <div class="box-header">
            <h3>Practicing</h3>
            <span class="word-count">0</span>
          </div>
        </div>
        <div class="box" onclick="vocabularyManager.showFlashcards(25)">
          <div class="box-header">
            <h3>Beginning</h3>
            <span class="word-count">0</span>
          </div>
        </div>
        <div class="box" onclick="vocabularyManager.showFlashcards(0)">
          <div class="box-header">
            <h3>New</h3>
            <span class="word-count">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Flashcard Modal -->
    <div class="flashcard-modal" id="flashcardModal">
      <div class="flashcard-container">
        <div class="flashcard">
          <!-- Mặt trước của flashcard -->
          <div class="card-face front">
            <div class="card-content">
              <div class="card-image"></div>
              <div class="card-word"></div>
              <button
                class="audio-btn action-btn"
                onclick="event.stopPropagation(); vocabularyManager.playAudio(document.querySelector('.card-word').textContent)"
              >
                <i class="fas fa-volume-up"></i>
              </button>
            </div>
          </div>

          <!-- Mặt sau của flashcard -->
          <div class="card-face back">
            <div class="card-content">
              <div class="card-meaning"></div>
            </div>
          </div>
        </div>

        <!-- Các nút điều khiển -->
        <div class="card-controls">
          <button onclick="vocabularyManager.previousCard()">
            <i class="fas fa-chevron-left"></i> Previous
          </button>
          <button onclick="vocabularyManager.closeFlashcards()">
            <i class="fas fa-times"></i> Close
          </button>
          <button onclick="vocabularyManager.nextCard()">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="settings-modal" id="settingsModal">
      <div class="settings-content">
        <div class="settings-header">
          <h2>Settings</h2>
          <span
            class="settings-close"
            onclick="vocabularyManager.closeSettings()"
            >&times;</span
          >
        </div>
        <div class="settings-option">
          <span>Dark Mode</span>
          <label class="switch">
            <input
              type="checkbox"
              id="darkModeToggle"
              onchange="vocabularyManager.toggleDarkMode()"
            />
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <span>Auto-play Pronunciation</span>
          <label class="switch">
            <input type="checkbox" id="autoPlayToggle" />
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <span>Reset Progress</span>
          <button
            onclick="vocabularyManager.resetProgress()"
            style="background-color: #e74c3c"
          >
            Reset
          </button>
        </div>
      </div>
    </div>

    <button class="settings-btn" onclick="vocabularyManager.openSettings()">
      <i class="fas fa-cog"></i>
    </button>

    <div class="notification" id="notification"></div>
    <script>
      class VocabularyManager {
        constructor() {
          this.vocabulary = [];
          this.currentCardIndex = 0;
          this.currentLevel = null;
          this.settings = this.loadSettings();
          this.streak = this.loadStreak();
          this.lastStudyDate = localStorage.getItem("lastStudyDate");
          this.currentImage = null;

          // Initialize
          this.loadVocabulary();
          this.initChart();
          this.setupEventListeners();
          this.updateDisplay();
          this.updateCurrentDate();
          this.checkAndUpdateLevels();

          // Check streak and levels every minute
          setInterval(() => {
            this.checkAndUpdateLevels();
            this.updateCurrentDate();
          }, 60000);

          // Check when tab becomes visible
          document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
              this.checkAndUpdateLevels();
              this.updateCurrentDate();
            }
          });

          // Thêm kiểm tra xoay màn hình
          this.checkOrientation();
          window.addEventListener("resize", () => this.checkOrientation());
          window.addEventListener("orientationchange", () => {
            setTimeout(() => this.checkOrientation(), 100); // Thêm delay nhỏ để đảm bảo orientation đã thay đổi
          });
        }

        // Thêm phương thức mới ngay sau constructor
        checkOrientation() {
          if (typeof window.orientation !== "undefined") {
            // Kiểm tra nếu là thiết bị di động
            const rotateNotice = document.getElementById("rotateNotice");
            if (
              window.innerWidth < 768 &&
              window.innerHeight > window.innerWidth
            ) {
              // Điện thoại ở chế độ dọc
              rotateNotice.style.display = "flex";
              document.querySelector(".container").style.display = "none";
            } else {
              // Điện thoại ở chế độ ngang hoặc màn hình lớn
              rotateNotice.style.display = "none";
              document.querySelector(".container").style.display = "block";
            }
          }
        }

        loadSettings() {
          return (
            JSON.parse(localStorage.getItem("settings")) || {
              darkMode: false,
              autoPlay: false,
              notificationInterval: 30,
            }
          );
        }

        saveSettings() {
          localStorage.setItem("settings", JSON.stringify(this.settings));
        }

        loadStreak() {
          return parseInt(localStorage.getItem("streak")) || 0;
        }

        updateCurrentDate() {
          const now = new Date();
          const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          };
          document.getElementById("currentDate").textContent =
            now.toLocaleDateString("en-US", options);
        }

        initChart() {
          const ctx = document
            .getElementById("retentionChart")
            .getContext("2d");
          this.chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: [
                "Day 1",
                "Day 2",
                "Day 3",
                "Day 4",
                "Day 5",
                "Day 6",
                "Day 7",
              ],
              datasets: [
                {
                  label: "Memory Retention",
                  data: [100, 75, 50, 25, 10, 5, 0],
                  borderColor: "#3498db",
                  backgroundColor: "rgba(52, 152, 219, 0.1)",
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                },
              },
            },
          });
        }

        loadVocabulary() {
          try {
            const saved = localStorage.getItem("vocabulary");
            this.vocabulary = saved ? JSON.parse(saved) : [];
          } catch (error) {
            console.error("Error loading vocabulary:", error);
            this.vocabulary = [];
          }
        }

        saveVocabulary() {
          try {
            localStorage.setItem("vocabulary", JSON.stringify(this.vocabulary));
            this.updateDisplay();
            this.updateStatistics();
          } catch (error) {
            console.error("Error saving vocabulary:", error);
            this.showNotification("Couldn't save vocabulary", "error");
          }
        }

        checkAndUpdateLevels() {
          const now = Date.now();
          let hasChanges = false;

          this.vocabulary = this.vocabulary.map((word) => {
            if (!word.startTime) return word;

            const timeElapsed = now - word.startTime;
            let newLevel = word.level;

            if (timeElapsed >= 240000) {
              // 4 minutes
              newLevel = 0;
            } else if (timeElapsed >= 180000) {
              // 3 minutes
              newLevel = 25;
            } else if (timeElapsed >= 120000) {
              // 2 minutes
              newLevel = 50;
            } else if (timeElapsed >= 60000) {
              // 1 minute
              newLevel = 75;
            }

            if (newLevel !== word.level) {
              hasChanges = true;
              return { ...word, level: newLevel, lastReviewed: now };
            }

            return word;
          });

          if (hasChanges) {
            this.saveVocabulary();
          }
        }

        updateStatistics() {
          const totalWords = this.vocabulary.length;
          const masteredWords = this.vocabulary.filter(
            (w) => w.level === 100
          ).length;
          const totalReviews = this.vocabulary.reduce(
            (sum, w) => sum + w.reviewCount,
            0
          );
          const totalMistakes = this.vocabulary.reduce(
            (sum, w) => sum + w.mistakes,
            0
          );

          const accuracy =
            totalReviews > 0
              ? Math.round(
                  ((totalReviews - totalMistakes) / totalReviews) * 100
                )
              : 0;

          document.getElementById("totalWords").textContent = totalWords;
          document.getElementById("masteredWords").textContent = masteredWords;
          document.getElementById("learningStreak").textContent = this.streak;
          document.getElementById(
            "reviewAccuracy"
          ).textContent = `${accuracy}%`;
        }
        handleImageUpload(event) {
          const file = event.target.files[0];
          if (file && file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = (e) => {
              this.currentImage = e.target.result;
              this.updateImagePreview();
            };
            reader.readAsDataURL(file);
          }
        }

        updateImagePreview() {
          const preview = document.getElementById("imagePreview");
          if (this.currentImage) {
            preview.innerHTML = `
      <img src="${this.currentImage}" alt="Word image">
      <button class="remove-image" onclick="vocabularyManager.removeImage()">
        <i class="fas fa-times"></i>
      </button>
    `;
          } else {
            preview.innerHTML = "";
          }
        }

        removeImage() {
          this.currentImage = null;
          this.updateImagePreview();
          document.getElementById("wordImage").value = "";
        }

        addWord() {
          const englishInput = document.getElementById("englishWord");
          const vietnameseInput = document.getElementById("vietnameseMeaning");

          const english = this.sanitizeInput(englishInput.value);
          const vietnamese = this.sanitizeInput(vietnameseInput.value);

          if (!this.validateInputs(english, vietnamese)) return;

          const newWord = {
            id: this.generateUniqueId(),
            english,
            vietnamese,
            level: 100,
            startTime: Date.now(),
            lastReviewed: null,
            reviewCount: 0,
            mistakes: 0,
            image: this.currentImage, // Thêm ảnh vào từ vựng
          };

          this.vocabulary.push(newWord);
          this.saveVocabulary();
          this.clearInputs(englishInput, vietnameseInput);
          this.removeImage(); // Xóa ảnh sau khi thêm từ
          this.showNotification(`Added: ${english}`);

          if (this.settings.autoPlay) {
            this.playAudio(english);
          }
        }

        updateFlashcard() {
          const words = this.vocabulary.filter(
            (word) => word.level === this.currentLevel
          );
          if (words.length > 0) {
            const currentWord = words[this.currentCardIndex];
            const cardWord = document.querySelector(".card-word");
            const cardMeaning = document.querySelector(".card-meaning");
            const cardImage = document.querySelector(".card-image");

            cardWord.textContent = currentWord.english;
            cardMeaning.textContent = currentWord.vietnamese;

            // Update image if exists
            if (currentWord.image) {
              cardImage.innerHTML = `<img src="${currentWord.image}" alt="${currentWord.english}">`;
            } else {
              cardImage.innerHTML = "";
            }

            document.querySelector(".flashcard").classList.remove("flipped");
          }
        }
        deleteWord(id) {
          try {
            const wordIndex = this.vocabulary.findIndex((w) => w.id === id);
            if (wordIndex !== -1) {
              const deletedWord = this.vocabulary[wordIndex];
              this.vocabulary.splice(wordIndex, 1);
              this.saveVocabulary();
              this.showNotification(`Deleted: ${deletedWord.english}`);
            }
          } catch (error) {
            console.error("Error deleting word:", error);
            this.showNotification("Couldn't delete word", "error");
          }
        }

        updateDisplay() {
          const levels = [100, 75, 50, 25, 0];
          levels.forEach((level) => {
            const wordsAtLevel = this.vocabulary.filter(
              (word) => word.level === level
            );
            const box = document.querySelector(
              `[onclick="vocabularyManager.showFlashcards(${level})"]`
            );
            const countSpan = box.querySelector(".word-count");
            countSpan.textContent = wordsAtLevel.length;
          });
        }

        createWordHTML(word) {
          return `
    <div class="word-item" data-id="${word.id}">
      <div class="word-content">
        ${
          word.image
            ? `<div class="word-image"><img src="${word.image}" alt="${word.english}"></div>`
            : ""
        }
        <div class="word-text">${word.english}</div>
        <div class="word-translation">${word.vietnamese}</div>
      </div>
      <div class="word-actions">
        <button class="audio-btn action-btn" onclick="event.stopPropagation(); vocabularyManager.playAudio('${
          word.english
        }')">
          <i class="fas fa-volume-up"></i>
        </button>
        <button class="delete-btn action-btn" onclick="event.stopPropagation(); vocabularyManager.deleteWord('${
          word.id
        }')">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  `;
        }

        showFlashcards(level) {
          const words = this.vocabulary.filter((word) => word.level === level);
          if (words.length === 0) {
            this.showNotification("No words at this level", "error");
            return;
          }

          this.currentLevel = level;
          this.currentCardIndex = 0;
          this.updateFlashcard();
          document.getElementById("flashcardModal").style.display = "flex";
        }

        updateFlashcard() {
          const words = this.vocabulary.filter(
            (word) => word.level === this.currentLevel
          );
          if (words.length > 0) {
            const currentWord = words[this.currentCardIndex];
            const cardWord = document.querySelector(".card-word");
            const cardMeaning = document.querySelector(".card-meaning");
            const cardImage = document.querySelector(
              ".card-face.front .card-image"
            ); // Sửa selector để đúng với cấu trúc HTML

            // Cập nhật từ và nghĩa
            cardWord.textContent = currentWord.english;
            cardMeaning.textContent = currentWord.vietnamese;

            // Cập nhật ảnh nếu có
            if (currentWord.image) {
              cardImage.innerHTML = `<img src="${currentWord.image}" alt="${currentWord.english}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
            } else {
              cardImage.innerHTML = ""; // Xóa ảnh nếu từ không có ảnh
            }

            // Reset card về mặt trước
            const flashcard = document.querySelector(".flashcard");
            flashcard.classList.remove("flipped");
          }
        }

        flipCard(event) {
          // Prevent flip if clicking audio button
          if (event && event.target.closest(".audio-btn")) {
            return;
          }
          const flashcard = document.querySelector(".flashcard");
          flashcard.classList.toggle("flipped");
        }

        showFlashcards(level) {
          const words = this.vocabulary.filter((word) => word.level === level);
          if (words.length === 0) {
            this.showNotification("No words at this level", "error");
            return;
          }

          this.currentLevel = level;
          this.currentCardIndex = 0;
          this.updateFlashcard();

          const modal = document.getElementById("flashcardModal");
          modal.style.display = "flex";

          // Add click event listener to flashcard
          const flashcard = document.querySelector(".flashcard");
          flashcard.onclick = (e) => this.flipCard(e);
        }

        nextCard() {
          const words = this.vocabulary.filter(
            (word) => word.level === this.currentLevel
          );
          this.currentCardIndex = (this.currentCardIndex + 1) % words.length;
          this.updateFlashcard();
        }

        previousCard() {
          const words = this.vocabulary.filter(
            (word) => word.level === this.currentLevel
          );
          this.currentCardIndex =
            (this.currentCardIndex - 1 + words.length) % words.length;
          this.updateFlashcard();
        }

        closeFlashcards() {
          const modal = document.getElementById("flashcardModal");
          modal.style.display = "none";

          // Remove click event listener
          const flashcard = document.querySelector(".flashcard");
          flashcard.onclick = null;
        }

        playAudio(word) {
          try {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = "en-US";
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
          } catch (error) {
            console.error("Error playing audio:", error);
            this.showNotification("Couldn't play audio", "error");
          }
        }

        filterWords(query) {
          const normalizedQuery = query.toLowerCase().trim();
          const filteredWords = this.vocabulary.filter(
            (word) =>
              word.english.toLowerCase().includes(normalizedQuery) ||
              word.vietnamese.toLowerCase().includes(normalizedQuery)
          );
          this.displayFilteredWords(filteredWords);
        }

        displayFilteredWords(words) {
          const levels = [100, 75, 50, 25, 0];
          levels.forEach((level) => {
            const wordsAtLevel = words.filter((word) => word.level === level);
            const box = document.getElementById(`box${level}`);
            const countSpan = box.parentElement.querySelector(".word-count");

            countSpan.textContent = wordsAtLevel.length;
            box.innerHTML = wordsAtLevel
              .map(this.createWordHTML.bind(this))
              .join("");
          });
        }

        exportVocabulary() {
          const data = JSON.stringify(this.vocabulary, null, 2);
          const blob = new Blob([data], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `vocabulary_${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        async importVocabulary() {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = ".json";

          input.onchange = async (e) => {
            try {
              const file = e.target.files[0];
              const text = await file.text();
              const importedVocabulary = JSON.parse(text);

              if (Array.isArray(importedVocabulary)) {
                this.vocabulary = [...this.vocabulary, ...importedVocabulary];
                this.saveVocabulary();
                this.showNotification(
                  `Imported ${importedVocabulary.length} words`
                );
              }
            } catch (error) {
              console.error("Error importing vocabulary:", error);
              this.showNotification("Error importing vocabulary", "error");
            }
          };

          input.click();
        }

        openSettings() {
          const settingsModal = document.getElementById("settingsModal");
          settingsModal.style.display = "flex";
          // Thêm class để ngăn scroll khi modal mở
          document.body.style.overflow = "hidden";

          // Cập nhật trạng thái các toggle
          document.getElementById("darkModeToggle").checked =
            this.settings.darkMode;
          document.getElementById("autoPlayToggle").checked =
            this.settings.autoPlay;
        }

        closeSettings() {
          const settingsModal = document.getElementById("settingsModal");
          settingsModal.style.display = "none";
          // Khôi phục scroll
          document.body.style.overflow = "auto";
        }

        toggleDarkMode() {
          this.settings.darkMode = !this.settings.darkMode;
          document.body.classList.toggle("dark-mode");
          this.saveSettings();
        }

        resetProgress() {
          if (
            confirm(
              "Are you sure you want to reset all progress? This cannot be undone."
            )
          ) {
            this.vocabulary = [];
            this.streak = 0;
            localStorage.removeItem("vocabulary");
            localStorage.removeItem("streak");
            this.saveVocabulary();
            this.showNotification("Progress reset successfully");
          }
        }

        setupEventListeners() {
          document
            .getElementById("englishWord")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                document.getElementById("vietnameseMeaning").focus();
              }
            });

          document
            .getElementById("vietnameseMeaning")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                this.addWord();
              }
            });

          document.addEventListener("keydown", (e) => {
            if (
              document.getElementById("flashcardModal").style.display === "flex"
            ) {
              switch (e.key) {
                case "ArrowRight":
                  this.nextCard();
                  break;
                case "ArrowLeft":
                  this.previousCard();
                  break;
                case " ":
                  this.flipCard();
                  e.preventDefault();
                  break;
                case "Escape":
                  this.closeFlashcards();
                  break;
              }
            }
          });

          // Apply saved settings
          if (this.settings.darkMode) {
            document.body.classList.add("dark-mode");
          }
        }

        sanitizeInput(input) {
          return input.trim().replace(/[<>]/g, "").replace(/\s+/g, " ");
        }

        validateInputs(english, vietnamese) {
          if (!english || !vietnamese) {
            this.showNotification("Please fill in all fields", "error");
            return false;
          }

          if (
            this.vocabulary.some(
              (w) => w.english.toLowerCase() === english.toLowerCase()
            )
          ) {
            this.showNotification("This word already exists", "error");
            return false;
          }

          return true;
        }

        generateUniqueId() {
          return (
            Date.now().toString() + Math.random().toString(36).substr(2, 9)
          );
        }

        clearInputs(englishInput, vietnameseInput) {
          englishInput.value = "";
          vietnameseInput.value = "";
          englishInput.focus();
        }

        showNotification(message, type = "success") {
          const notification = document.getElementById("notification");
          notification.textContent = message;
          notification.style.background =
            type === "success" ? "#2ecc71" : "#e74c3c";
          notification.style.display = "block";

          setTimeout(() => {
            notification.style.display = "none";
          }, 3000);
        }
      }

      // Initialize the vocabulary manager
      const vocabularyManager = new VocabularyManager();
    </script>
    <div class="rotate-notice" id="rotateNotice">
      <div class="rotate-content">
        <i class="fas fa-mobile-alt"></i>
        <p>Please rotate your device horizontally for the best experience</p>
      </div>
    </div>
  </body>
</html>
